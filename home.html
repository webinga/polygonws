<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        let webSocket = new WebSocket(location.origin.replace(/^http/, 'ws'));
        let el;
        var price;
        /*
        webSocket.onmessage = (event) => {
          var i=0
          //while(event!=""){
          //  console.log("ss")
          el = document.getElementById('time');
          el.innerHTML = 'Streaming' + event.data;
          //const para = document.createElement("p");
          //para.setAttribute("id", i++);
          //document.body.appendChild(para);
          //para.innerHTML = 'Streaming' + event.data;
          console.log(event.data);
          price = event.data;
          //}
          //console.log(event.data);
        }*/
      </script>
      <script type="text/javascript" src="https://cdn.canvasjs.com/canvasjs.stock.min.js"></script>
      <script type="text/javascript">
        window.onload = function () {
          var dataPoints = [], currentDate = new Date(), rangeChangedTriggered = false;
          var stockChart = new CanvasJS.StockChart("chartContainer",{
            theme: "light2",
            title:{
              text:"BTC-USD StockChart"
            },
            rangeChanged: function(e) {
                rangeChangedTriggered = true;
            },
            charts: [{
              axisX: {
                 crosshair: {
                  enabled: true,
                  valueFormatString: "MMM DD, YYYY HH:mm:ss"
                }
              },
              axisY: {
                title: "Pageviews Per Second",
                stripLines: [{
                  showOnTop: true,
                  lineDashType: "dash",
                  color: "#ff4949",
                  labelFontColor: "#ff4949",
                  labelFontSize: 14
                }]
              },
              toolTip: {
                shared: true
              },
              data: [{
                type: "line",
                name: "Pageviews",
                xValueFormatString: "MMM DD, YYYY HH:mm:ss",
                xValueType: "dateTime",
                dataPoints : dataPoints
              }]
            }],
            navigator: {
              slider: {
                minimum: new Date(currentDate.getTime() - (90 * 1000))
              }
            },
            rangeSelector: {
              enabled: false
            }
          });
          var dataCount = 700, ystart = 50, interval = 1000, xstart = (currentDate.getTime() - (700 * 1000));
          updateChart(xstart, ystart, dataCount, interval);
          function updateChart(xstart, ystart, length, interval) {
            var xVal = xstart, yVal = ystart;
            for(var i = 0; i < length; i++) {
              webSocket.onmessage = (event) => {
         // var i=0
          //while(event!=""){
          //  console.log("ss")
          el = document.getElementById('time');
          el.innerHTML = 'Streaming BTC-USD price: ' + event.data;
          //const para = document.createElement("p");
          //para.setAttribute("id", i++);
          //document.body.appendChild(para);
          //para.innerHTML = 'Streaming' + event.data;
          console.log(event.data);
          price = event.data;
          //}
          //console.log(event.data);
          //yVal = yVal +  Math.round(5 + Math.random() *(-5-5));
          yVal = event.data;
        }
             // yVal = yVal +  Math.round(5 + Math.random() *(-5-5));
              yVal = Math.min(Math.max(price, 20000), 35000);
              dataPoints.push({x: xVal,y: yVal});
              xVal += interval;
            }
            if(!rangeChangedTriggered) {
                stockChart.options.navigator.slider.minimum = new Date(xVal - (90 * 1000));
            }
            stockChart.options.charts[0].axisY.stripLines[0].value =  dataPoints[dataPoints.length - 1].y;
            stockChart.options.charts[0].axisY.stripLines[0].label = stockChart.options.charts[0].axisY.stripLines[0]["value"];
            xstart = xVal;
            dataCount = 1;
            ystart = yVal;
            stockChart.render();
            setTimeout(function() { updateChart(xstart, ystart, dataCount, interval); }, 1000);
          }
        }
        </script>
</head>
<body>
    <p id="time"></p>
    <div id="chartContainer" style="height: 450px; width: 100%;"></div>
</body>
</html>
